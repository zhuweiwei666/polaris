services:
  api:
    build:
      context: ../../
      dockerfile: apps/api/Dockerfile
    environment:
      NODE_ENV: production
      PORT: "8080"
      # Optional - enable when ready
      DATABASE_URL: ${DATABASE_URL-}
      REDIS_URL: ${REDIS_URL-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY-}
      A2E_API_KEY: ${A2E_API_KEY-}
      GCS_BUCKET: ${GCS_BUCKET-}
    restart: unless-stopped
    networks: [appnet]

  web:
    build:
      context: ../../
      dockerfile: apps/web/Dockerfile
      args:
        # Browser uses same-origin /api (served by nginx) to reach api.
        NEXT_PUBLIC_API_BASE_URL: "/api"
    environment:
      NODE_ENV: production
      PORT: "8080"
      # Server-side (SSR) fetch uses docker network to reach api.
      API_INTERNAL_BASE_URL: "http://api:8080/api"
      NEXT_PUBLIC_API_BASE_URL: "/api"
    restart: unless-stopped
    depends_on: [api]
    networks: [appnet]

  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on: [web, api]
    restart: unless-stopped
    networks: [appnet]

networks:
  appnet:
    driver: bridge

